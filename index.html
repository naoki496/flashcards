<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#07080b" />
  <title>八東古文単語</title>

  <style>
    :root{
      --bg:#07080b;

      /* ✅ Violet theme */
      --accent:#B56CFF;     /* violet core */
      --accent2:#62d6ff;    /* cyan accent */
      --ok:#5cffb7;
      --danger:#ff5c7a;

      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);

      --radius:18px;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --minTap:44px;
      --maxW:980px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
              "Hiragino Kaku Gothic ProN","Hiragino Sans","Noto Sans JP",
              "Yu Gothic UI","Yu Gothic","Meiryo",sans-serif;
    }

    html,body{height:100%;}
    body{
      margin:0;
      color:var(--text);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 18% 12%, rgba(181,108,255,.22), transparent 60%),
        radial-gradient(980px 560px at 86% 16%, rgba(98,214,255,.14), transparent 62%),
        radial-gradient(900px 520px at 60% 110%, rgba(92,255,183,.08), transparent 60%),
        linear-gradient(180deg, #06070a, #04050a 55%, #020309);
      overflow-x:hidden;
    }

    .wrap{
      max-width:var(--maxW);
      margin:0 auto;
      padding:18px 14px 28px;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
      letter-spacing:.02em;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brandMark{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(181,108,255,.55);
      flex:0 0 auto;
    }

    .glass{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .kpis{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;
      background:var(--accent);
      box-shadow:0 0 16px rgba(181,108,255,.55);
    }
    .dot.ok{ background:var(--ok); box-shadow:0 0 16px rgba(92,255,183,.35); }

    .main{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .card{
      padding:16px 14px;
      position:relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:inherit;
      background:
        radial-gradient(520px 220px at 30% 0%, rgba(181,108,255,.16), transparent 55%),
        radial-gradient(420px 220px at 90% 10%, rgba(98,214,255,.12), transparent 55%);
      pointer-events:none;
      opacity:.95;
    }
    .card > *{ position:relative; }

    .cardHeader{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    button{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:14px;
      min-height:var(--minTap);
      padding:10px 14px;
      font-weight:700;
      letter-spacing:.01em;
      cursor:pointer;
      transition: transform .06s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease;
      touch-action:manipulation;
    }
    button:hover{
      border-color:rgba(181,108,255,.45);
      box-shadow:0 0 0 3px rgba(181,108,255,.16), 0 18px 50px rgba(0,0,0,.25);
      background:rgba(181,108,255,.06);
    }
    button:active{ transform: translateY(1px); }

    .primaryBtn{
      background:linear-gradient(180deg, rgba(181,108,255,.20), rgba(255,255,255,.06));
      border-color:rgba(181,108,255,.55);
      box-shadow:0 0 0 2px rgba(181,108,255,.16);
    }
    .secondaryBtn{ background:rgba(255,255,255,.05); }
    .ghostBtn{
      background:transparent;
      border-style:dashed;
      color:rgba(255,255,255,.75);
    }

    .bgmBtn[data-on="true"]{
      border-color:rgba(92,255,183,.55);
      background:rgba(92,255,183,.10);
      box-shadow:0 0 0 2px rgba(92,255,183,.14);
    }

    .miniBtn{
      min-width:44px;
      min-height:44px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      line-height:1;
    }

    .fc{
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      position:relative;
    }

    .fcTop{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .status{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .status strong{ color:rgba(255,255,255,.86); }

    .navArrows{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .fcBody{
      padding:16px 14px 18px;
      min-height:175px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .front{
      font-size:20px;
      letter-spacing:.02em;
      line-height:1.42;
      white-space:pre-wrap;
    }
    .back{
      font-size:16px;
      color:rgba(255,255,255,.82);
      line-height:1.60;
      white-space:pre-wrap;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.14);
      display:none;
    }
    .back.show{ display:block; }

    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }

    /* Swipe affordance */
    .swipeAfford{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      user-select:none;
    }
    .affSide{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .affPills{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .affPill{
      font-family:var(--mono);
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      color:rgba(255,255,255,.78);
      white-space:nowrap;
    }

    .chev{
      width:30px;
      height:18px;
      display:inline-block;
      position:relative;
      opacity:.80;
      filter: drop-shadow(0 0 10px rgba(181,108,255,.12));
    }
    .chev::before, .chev::after{
      content:"";
      position:absolute;
      top:50%;
      width:10px;
      height:10px;
      border-right:2px solid rgba(255,255,255,.75);
      border-bottom:2px solid rgba(255,255,255,.75);
      transform: translateY(-50%) rotate(135deg);
      opacity:.75;
      animation: nudgeL 1.4s ease-in-out infinite;
    }
    .chev::after{
      left:12px;
      opacity:.42;
      animation-delay:.14s;
    }
    .chev.left::before, .chev.left::after{
      transform: translateY(-50%) rotate(315deg);
      animation-name:nudgeR;
    }

    @keyframes nudgeL{
      0%{ transform: translate(0, -50%) rotate(135deg); opacity:.55; }
      50%{ transform: translate(-6px, -50%) rotate(135deg); opacity:.85; }
      100%{ transform: translate(0, -50%) rotate(135deg); opacity:.55; }
    }
    @keyframes nudgeR{
      0%{ transform: translate(0, -50%) rotate(315deg); opacity:.55; }
      50%{ transform: translate(6px, -50%) rotate(315deg); opacity:.85; }
      100%{ transform: translate(0, -50%) rotate(315deg); opacity:.55; }
    }

    .edgeGlow{
      pointer-events:none;
      position:absolute;
      inset:0;
      opacity:0;
      transition: opacity .15s ease;
    }
    .edgeGlow.on{ opacity:1; }
    .edgeGlow.left{
      background: radial-gradient(520px 220px at 0% 50%, rgba(181,108,255,.22), transparent 60%);
    }
    .edgeGlow.right{
      background: radial-gradient(520px 220px at 100% 50%, rgba(181,108,255,.22), transparent 60%);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.66);
      color:rgba(255,255,255,.9);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      padding:10px 14px;
      font-size:12.5px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:9999;
      max-width:min(92vw, 680px);
      text-align:center;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }

    .swipeArea{ touch-action: pan-y; }

    .smallNote{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      margin-top:8px;
    }

    details{ margin-top:12px; }
    summary{
      cursor:pointer;
      color:rgba(255,255,255,.85);
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      user-select:none;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .maint{
      padding:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.55;
    }

    input[type="file"]{
      display:block;
      width:100%;
      margin-top:10px;
      color:rgba(255,255,255,.84);
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 740px){
      .row2{ grid-template-columns: 1fr 1fr; }
    }

    .mono{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.80);
    }
    .muted{ color:var(--muted); }
  </style>
</head>

<body>
  <div class="wrap swipeArea" id="swipeRoot">
    <div class="topbar">
      <div class="brand">
        <h1><span class="brandMark"></span>八東古文単語</h1>
      </div>

      <div class="kpis">
        <div class="pill"><span class="dot"></span><span>総数</span><strong id="kpiTotal">-</strong></div>
        <div class="pill"><span class="dot ok"></span><span>今日</span><strong id="kpiToday">-</strong></div>
      </div>
    </div>

    <div class="main">
      <section class="glass card" id="uiCardPanel">
        <div class="cardHeader">
          <button class="secondaryBtn bgmBtn" id="btnBgm" data-on="false" type="button">BGM: OFF</button>
          <audio id="bgmAudio" preload="none" loop>
            <source src="./assets/bgm/study.mp3" type="audio/mpeg" />
          </audio>
        </div>

        <div class="fc" id="cardBox" aria-live="polite">
          <div class="edgeGlow left" id="glowLeft"></div>
          <div class="edgeGlow right" id="glowRight"></div>

          <div class="fcTop">
            <div class="status" id="statusText">
              <strong id="idxText">-</strong>
              <span style="opacity:.45;">/</span>
              <span id="totalText">-</span>
              <span style="opacity:.45;">・</span>
              <span id="seenText">seen: -</span>
            </div>
            <div class="navArrows">
              <button class="secondaryBtn miniBtn" id="btnPrev" type="button" aria-label="前へ戻る">←</button>
              <button class="secondaryBtn miniBtn" id="btnNext" type="button" aria-label="次へ">→</button>
            </div>
          </div>

          <div class="fcBody">
            <div class="front" id="frontText">読み込み中…</div>
            <div class="back" id="backText"></div>

            <div class="btnRow">
              <button class="primaryBtn" id="btnToggle" type="button">答えを見る</button>
              <button class="secondaryBtn" id="btnShuffle" type="button">シャッフル</button>
              <button class="ghostBtn" id="btnResetToday" type="button">今日カウントをリセット</button>
            </div>

            <div class="swipeAfford" aria-label="swipe affordance">
              <div class="affSide">
                <span class="chev left" aria-hidden="true"></span>
                <div class="affPills">
                  <span class="affPill">←</span>
                  <span class="muted">戻る</span>
                </div>
              </div>

              <div class="affSide" style="justify-content:center; flex:1;">
                <span class="muted" style="white-space:nowrap;">左右スワイプ操作可</span>
              </div>

              <div class="affSide" style="justify-content:flex-end;">
                <div class="affPills">
                  <span class="muted">次へ</span>
                  <span class="affPill">→</span>
                </div>
                <span class="chev" aria-hidden="true"></span>
              </div>
            </div>

            <div class="smallNote">
              ※BGMはボタン操作後に再生できます（自動再生はしません）
            </div>
          </div>
        </div>
      </section>

      <details>
        <summary>メンテ用（通常は生徒は触らない）</summary>
        <div class="maint">
          <div>
            <strong>UIが変わらない／更新が反映されない：</strong><br>
            PWAキャッシュの可能性が高いです。SW更新 → ハードリロード → サイトデータ削除で確認してください。
          </div>

          <div class="row2">
            <div class="glass" style="padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);box-shadow:none;">
              <div style="font-weight:700;color:rgba(255,255,255,.86);">CSVを手動インポート</div>
              <div class="smallNote">列名は柔軟に解釈します（front/back、question/answer、term/meaning等）。</div>
              <input type="file" id="fileCsv" accept=".csv,text/csv" />
              <div class="btnRow">
                <button class="secondaryBtn" id="btnLoadDefault" type="button">デフォルトCSVを再読込</button>
              </div>
            </div>

            <div class="glass" style="padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);box-shadow:none;">
              <div style="font-weight:700;color:rgba(255,255,255,.86);">データ初期化</div>
              <div class="smallNote">
                進捗（見た記録）と今日カウントを初期化します。<br>
                ※学習用端末を使い回す場合のみ。
              </div>
              <div class="btnRow">
                <button class="ghostBtn" id="btnResetAll" type="button">全て初期化</button>
              </div>
              <div class="smallNote mono">Storage key prefix: <span id="storageKeyHint"></span></div>
            </div>
          </div>
        </div>
      </details>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /********************
     * 基本設定（古文単語）
     ********************/
    const STORAGE_PREFIX = "hattoKobunFlash.v1";
    const KEY_STATE      = STORAGE_PREFIX + ".state";
    const KEY_SEEN       = STORAGE_PREFIX + ".seenIds";
    const KEY_TODAY      = STORAGE_PREFIX + ".today";
    const KEY_TODAY_DATE = STORAGE_PREFIX + ".todayDate";

    // ✅ デフォルト読み込み：deck_default.csv 固定
    const DEFAULT_CSV_CANDIDATES = [
      "./deck_default.csv",
      "./assets/deck_default.csv",
    ];

    // 内部保持（UIには出さない）
    let internalCsvUsed = "deck_default.csv";
    let internalUpdatedAt = "";

    const $ = (id)=>document.getElementById(id);

    const elFront = $("frontText");
    const elBack  = $("backText");
    const elIdx   = $("idxText");
    const elTotal = $("totalText");
    const elSeen  = $("seenText");
    const elKpiTotal = $("kpiTotal");
    const elKpiToday = $("kpiToday");
    const elToast = $("toast");

    const btnPrev = $("btnPrev");
    const btnNext = $("btnNext");
    const btnToggle = $("btnToggle");
    const btnShuffle = $("btnShuffle");
    const btnResetToday = $("btnResetToday");
    const btnResetAll = $("btnResetAll");
    const btnLoadDefault = $("btnLoadDefault");
    const fileCsv = $("fileCsv");

    const btnBgm = $("btnBgm");
    const audioBgm = $("bgmAudio");

    const glowLeft = $("glowLeft");
    const glowRight = $("glowRight");

    $("storageKeyHint").textContent = STORAGE_PREFIX;

    let cards = [];     // {id, front, back}
    let order = [];     // indices
    let idx = 0;        // order index
    let showBack = false;

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function showToast(msg){
      if(!elToast) return;
      elToast.textContent = msg;
      elToast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>elToast.classList.remove("show"), 1100);
    }

    function flashGlow(dir){
      const el = dir === "left" ? glowLeft : glowRight;
      if(!el) return;
      el.classList.add("on");
      clearTimeout(flashGlow._t);
      flashGlow._t = setTimeout(()=>el.classList.remove("on"), 180);
    }

    function loadJSON(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch{
        return fallback;
      }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }

    function getSeenSet(){
      const arr = loadJSON(KEY_SEEN, []);
      return new Set(arr);
    }
    function setSeenSet(set){
      saveJSON(KEY_SEEN, Array.from(set));
    }

    function getTodayCount(){
      const t = todayKey();
      const savedDate = localStorage.getItem(KEY_TODAY_DATE);
      if(savedDate !== t){
        localStorage.setItem(KEY_TODAY_DATE, t);
        localStorage.setItem(KEY_TODAY, "0");
        return 0;
      }
      return Number(localStorage.getItem(KEY_TODAY) || "0") || 0;
    }
    function incTodayCount(){
      const c = getTodayCount() + 1;
      localStorage.setItem(KEY_TODAY, String(c));
      return c;
    }
    function resetTodayCount(){
      localStorage.setItem(KEY_TODAY_DATE, todayKey());
      localStorage.setItem(KEY_TODAY, "0");
      return 0;
    }

    function persistState(){
      saveJSON(KEY_STATE, { idx, order, showBack });
    }
    function restoreState(){
      const st = loadJSON(KEY_STATE, null);
      if(!st) return;
      if(Array.isArray(st.order)) order = st.order;
      if(Number.isInteger(st.idx)) idx = st.idx;
      if(typeof st.showBack === "boolean") showBack = st.showBack;
    }

    function normalizeHeader(h){
      return String(h||"").trim().toLowerCase()
        .replace(/\s+/g,"")
        .replace(/[＿_]/g,"_");
    }

    function parseCSV(text){
      const rows = [];
      let i=0, field="", row=[], inQuotes=false;

      while(i < text.length){
        const c = text[i];

        if(inQuotes){
          if(c === '"'){
            if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        }else{
          if(c === '"'){ inQuotes = true; i++; continue; }
          if(c === ','){ row.push(field); field=""; i++; continue; }
          if(c === '\n'){
            row.push(field); field="";
            if(row.some(v => String(v).trim() !== "")) rows.push(row);
            row = [];
            i++; continue;
          }
          if(c === '\r'){ i++; continue; }
          field += c; i++; continue;
        }
      }
      row.push(field);
      if(row.some(v => String(v).trim() !== "")) rows.push(row);
      if(rows.length === 0) return [];

      const header = rows[0].map(normalizeHeader);
      const dataRows = rows.slice(1);

      const frontKeys = new Set(["front","question","q","term","word","表","おもて","問題","語","語句"]);
      const backKeys  = new Set(["back","answer","a","meaning","definition","裏","うら","解答","答え","意味","説明","訳"]);

      const frontIdx = header.findIndex(h => frontKeys.has(h));
      const backIdx  = header.findIndex(h => backKeys.has(h));
      const useHeader = (frontIdx !== -1 || backIdx !== -1);

      const out = [];
      for(let r=0; r<dataRows.length; r++){
        const cols = dataRows[r];
        const f = useHeader ? (cols[frontIdx] ?? "") : (cols[0] ?? "");
        const b = useHeader ? (cols[backIdx]  ?? "") : (cols[1] ?? "");
        const front = String(f ?? "").trim();
        const back  = String(b ?? "").trim();
        if(!front && !back) continue;
        out.push({ front, back });
      }
      return out;
    }

    function buildCards(parsed){
      const seen = new Map();
      return parsed.map((p)=>{
        const base = (p.front + "||" + p.back).trim();
        const n = (seen.get(base) || 0) + 1;
        seen.set(base, n);
        return {
          id: n === 1 ? base : `${base}#${n}`,
          front: p.front,
          back: p.back
        };
      });
    }

    async function fetchText(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`fetch failed: ${url}`);
      return await res.text();
    }

    async function loadDefaultCsvText(){
      let lastErr = null;
      for(const url of DEFAULT_CSV_CANDIDATES){
        try{
          const text = await fetchText(url);
          return { text, used: url };
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("deck_default.csv not found");
    }

    function clampIndex(){
      if(order.length === 0){ idx = 0; return; }
      if(idx < 0) idx = 0;
      if(idx >= order.length) idx = order.length - 1;
    }

    function currentCard(){
      if(cards.length === 0 || order.length === 0) return null;
      const ci = order[idx];
      return cards[ci] || null;
    }

    function updateKpis(){
      elKpiTotal.textContent = String(cards.length || 0);
      elTotal.textContent = String(cards.length || 0);
      elKpiToday.textContent = String(getTodayCount());
      elSeen.textContent = `seen: ${getSeenSet().size}`;
    }

    function render(){
      updateKpis();

      const c = currentCard();
      if(!c){
        elFront.textContent = "データがありません（CSVを確認してください）";
        elBack.textContent = "";
        elBack.classList.remove("show");
        elIdx.textContent = "-";
        btnToggle.disabled = true;
        btnPrev.disabled = true;
        btnNext.disabled = true;
        return;
      }

      btnToggle.disabled = false;
      btnPrev.disabled = (idx <= 0);
      btnNext.disabled = (idx >= order.length - 1);

      elIdx.textContent = String(idx + 1);
      elFront.textContent = c.front || "(表が空です)";
      elBack.textContent = c.back || "(裏が空です)";

      if(showBack){
        elBack.classList.add("show");
        btnToggle.textContent = "答えを隠す";
      }else{
        elBack.classList.remove("show");
        btnToggle.textContent = "答えを見る";
      }
    }

    function markSeen(card){
      if(!card) return;
      const seenSet = getSeenSet();
      if(!seenSet.has(card.id)){
        seenSet.add(card.id);
        setSeenSet(seenSet);
      }
    }

    function goRandom(){
      if(idx >= order.length - 1) return;
      idx++;
      showBack = false;
      const c = currentCard();
      markSeen(c);
      incTodayCount();
      persistState();
      render();
    }

    function goPrev(){
      if(idx <= 0) return;
      idx--;
      showBack = false;
      const c = currentCard();
      markSeen(c);
      persistState();
      render();
    }

    function toggleBack(){
      showBack = !showBack;
      persistState();
      render();
    }

    function shuffleOrder(){
      for(let i=order.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [order[i], order[j]] = [order[j], order[i]];
      }
      idx = 0;
      showBack = false;
      persistState();
      render();
      showToast("シャッフルしました");
    }

    function resetAll(){
      localStorage.removeItem(KEY_STATE);
      localStorage.removeItem(KEY_SEEN);
      localStorage.removeItem(KEY_TODAY);
      localStorage.removeItem(KEY_TODAY_DATE);
      order = cards.map((_,i)=>i);
      idx = 0;
      showBack = false;
      render();
      showToast("初期化しました");
    }

    // BGM（初期OFF）
    if(btnBgm && audioBgm){
      btnBgm.addEventListener("click", async ()=>{
        try{
          if(btnBgm.dataset.on === "true"){
            audioBgm.pause();
            btnBgm.dataset.on = "false";
            btnBgm.textContent = "BGM: OFF";
            showToast("BGMを停止");
          }else{
            await audioBgm.play();
            btnBgm.dataset.on = "true";
            btnBgm.textContent = "BGM: ON";
            showToast("BGMを再生");
          }
        }catch(e){
          showToast("BGMを再生できません（端末設定/操作起点を確認）");
        }
      });
    }

    // Swipe（右=戻る / 左=次へ）+ 視覚エフェクト
    (function setupSwipe(){
      const root = $("swipeRoot");
      if(!root) return;

      let sx=0, sy=0, st=0, moved=false;
      const THRESH = 46;
      const VERT_GUARD = 1.2;

      root.addEventListener("touchstart",(e)=>{
        const t = e.touches[0];
        sx = t.clientX; sy = t.clientY; st = Date.now();
        moved = false;
      }, {passive:true});

      root.addEventListener("touchmove",()=>{ moved = true; }, {passive:true});

      root.addEventListener("touchend",(e)=>{
        const t = e.changedTouches[0];
        const dx = t.clientX - sx;
        const dy = t.clientY - sy;
        const dt = Date.now() - st;

        if(!moved) return;
        if(dt > 700) return;
        if(Math.abs(dy) > Math.abs(dx) * VERT_GUARD) return;

        if(Math.abs(dx) >= THRESH){
          if(dx < 0){
            if(idx < order.length - 1){
              flashGlow("right");
              goNext();
              showToast("次へ");
            }else{
              flashGlow("right");
              showToast("最後のカードです");
            }
          }else{
            if(idx > 0){
              flashGlow("left");
              goPrev();
              showToast("前へ戻る");
            }else{
              flashGlow("left");
              showToast("これ以上戻れません");
            }
          }
        }
      }, {passive:true});
    })();

    // CSVインポート
    fileCsv.addEventListener("change", async ()=>{
      const f = fileCsv.files && fileCsv.files[0];
      if(!f) return;
      try{
        const text = await f.text();
        const parsed = parseCSV(text);
        const built = buildCards(parsed);
        if(built.length === 0){
          showToast("CSVが空です");
          return;
        }
        cards = built;
        order = cards.map((_,i)=>i);
        idx = 0;
        showBack = false;

        internalCsvUsed = f.name;
        internalUpdatedAt = new Date().toLocaleString();

        persistState();
        render();
        showToast("CSVを読み込みました");
      }catch(e){
        showToast("CSV読み込みに失敗しました");
      }finally{
        fileCsv.value = "";
      }
    });

    btnLoadDefault.addEventListener("click", async ()=>{ await boot(true); });

    btnNext.addEventListener("click", ()=>{
      if(idx < order.length - 1){
        flashGlow("right"); goRandom(); showToast("次へ");
      }else{
        flashGlow("right"); showToast("最後のカードです");
      }
    });
    btnPrev.addEventListener("click", ()=>{
      if(idx > 0){
        flashGlow("left"); goPrev(); showToast("前へ戻る");
      }else{
        flashGlow("left"); showToast("これ以上戻れません");
      }
    });
    btnToggle.addEventListener("click", toggleBack);
    btnShuffle.addEventListener("click", shuffleOrder);

    btnResetToday.addEventListener("click", ()=>{
      resetTodayCount();
      render();
      showToast("今日カウントをリセット");
    });

    btnResetAll.addEventListener("click", ()=>{
      const ok = confirm("進捗と今日カウントを初期化します。よろしいですか？");
      if(!ok) return;
      resetAll();
    });

    async function boot(forceReload=false){
      try{
        elFront.textContent = "読み込み中…";
        elBack.textContent = "";
        elBack.classList.remove("show");
        btnToggle.disabled = true;
        btnPrev.disabled = true;
        btnNext.disabled = true;

        if(!forceReload) restoreState();

        const { text, used } = await loadDefaultCsvText();
        const parsed = parseCSV(text);
        const built = buildCards(parsed);

        if(built.length === 0){
          cards = []; order = []; idx = 0; showBack = false;
          internalCsvUsed = used.replace("./","");
          internalUpdatedAt = new Date().toLocaleString();
          render();
          showToast("デフォルトCSVが空です");
          return;
        }

        cards = built;

        const okOrder = Array.isArray(order)
          && order.length === cards.length
          && order.every(n=>Number.isInteger(n) && n>=0 && n<cards.length);

        if(!okOrder){
          order = cards.map((_,i)=>i);
          idx = 0;
          showBack = false;
        }
        clampIndex();

        internalCsvUsed = used.replace("./","");
        internalUpdatedAt = new Date().toLocaleString();

        markSeen(currentCard());
        persistState();
        render();
      }catch(e){
        cards = []; order = []; idx = 0; showBack = false;
        render();
        showToast("deck_default.csv を読み込めません（配置/名前を確認）");
      }
    }

    boot(false);
  </script>

  <!-- PWA / SW register（reg.update()） -->
  <script>
    (function(){
      if(!("serviceWorker" in navigator)) return;

      window.addEventListener("load", async ()=>{
        try{
          const reg = await navigator.serviceWorker.register("./sw.js");
          try { await reg.update(); } catch {}
          reg.addEventListener("updatefound", ()=>{ console.log("[SW] updatefound"); });
        }catch(e){
          console.log("[SW] register failed", e);
        }
      });
    })();
  </script>
</body>
</html>
